{% extends "filmes/lista_filmes.html" %}
{% load static %}

{% block title %}Perfil de {{ perfil_modelo.get_nome_completo }} - Plume Project{% endblock %}

{% block extrastyles %}
    <link rel="stylesheet" href="{% static 'css/perfil_styles.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
{% endblock extrastyles %}

{% block content %}
<div class="container perfil-pagina-container">
    <section class="perfil-info-principal">
        <div class="perfil-avatar-coluna">
            <img src="{{ perfil_modelo.get_avatar_url }}" alt="Avatar de {{ perfil_modelo.get_nome_completo }}" class="perfil-avatar-img-x" id="avatarDisplay">
            <label for="avatarUploadInput" class="botao-acao-perfil botao-mudar-avatar-label">
                <i class="fas fa-camera"></i> Mudar Foto
            </label>
            <input type="file" id="avatarUploadInput" accept="image/png, image/jpeg, image/gif" style="display: none;">
            <button id="removeAvatarButton" 
                    class="botao-acao-perfil botao-remover-foto {% if not perfil_modelo.avatar.name %}hidden{% endif %}" 
                    title="Remover foto e usar avatar padrão">
                <i class="fas fa-trash-alt"></i> Remover
            </button>
        </div>
        <div class="perfil-detalhes-coluna">
            <h1 class="perfil-nome-completo">{{ perfil_modelo.get_nome_completo }}</h1>
            <p class="perfil-username">@{{ usuario_perfil.username }}</p>
            <div class="perfil-meta-info">
                {% if perfil_modelo.cidade %}<span class="meta-item"><i class="fas fa-map-marker-alt"></i> {{ perfil_modelo.cidade }}</span>{% endif %}
                {% if perfil_modelo.data_nascimento %}<span class="meta-item"><i class="fas fa-birthday-cake"></i> {{ perfil_modelo.data_nascimento|date:"d/m/Y" }}</span>{% endif %}
                <span class="meta-item"><i class="fas fa-calendar-alt"></i> No Plume desde {{ usuario_perfil.date_joined|date:"F Y" }}</span>
            </div>
            {% if perfil_modelo.biografia %}<p class="perfil-biografia-display">{{ perfil_modelo.biografia|linebreaksbr }}</p>
            {% else %}<p class="perfil-biografia-display"><i>Nenhuma biografia adicionada.</i></p>{% endif %}
        </div>
    </section>

    <nav class="perfil-nav-tabs">
        <ul>
            <li><a href="#" class="nav-link active" data-tab="tab-overview"><i class="fas fa-star"></i> Visão Geral</a></li>
            <li><a href="#" class="nav-link" data-tab="tab-lists"><i class="fas fa-list-alt"></i> Minhas Listas</a></li>
            <li><a href="#" class="nav-link" data-tab="tab-edit"><i class="fas fa-user-edit"></i> Editar Perfil</a></li>
            <li><a href="#" class="nav-link" data-tab="tab-account"><i class="fas fa-user-cog"></i> Conta</a></li>
        </ul>
    </nav>

    <div class="perfil-tab-content">
        <div id="tab-overview" class="tab-pane active">
            <div class="secao-listas-header">
                <h2 class="detalhe-secao-titulo">Meus Favoritos</h2>
                <div class="lista-acoes-modo-edicao">
                    <button id="botaoEditarFavoritos" class="botao-editar-lista"><i class="fas fa-edit"></i> Editar</button>
                    <button id="botaoConcluirEdicaoFavoritos" class="botao-concluir-edicao" style="display: none;"><i class="fas fa-check"></i> Concluir</button>
                </div>
            </div>
            <div class="filme-lista perfil-filme-lista" id="lista-favoritos-container">
                {% for filme_obj in favoritos_padrao.filmes.all %}
                    <div class="filme-item-wrapper-perfil" data-filme-card-idtmdb="{{ filme_obj.id_tmdb }}">
                        <a href="{% url 'detalhe_filme' filme_id=filme_obj.id_tmdb %}" class="filme-link-wrapper">
                            <div class="filme-item filme-item-perfil">
                                {% if filme_obj.poster_path %}
                                    <img src="{{ base_poster_url }}{{ filme_obj.poster_path }}" alt="Pôster de {{ filme_obj.titulo }}">
                                {% else %}
                                    <img class="imagem-placeholder" src="{% static 'img/placeholder_poster.png' %}" alt="Pôster indisponível">
                                {% endif %}
                                <div class="titulo-wrapper"><p class="filme-titulo">{{ filme_obj.titulo }}</p></div>
                            </div>
                        </a>
                        <button class="botao botao-remover-filme-lista" 
                                data-list-id="{{ favoritos_padrao.id }}" 
                                data-id-tmdb="{{ filme_obj.id_tmdb }}" 
                                title="Remover dos Favoritos">
                            <i class="fas fa-trash-alt"></i> REMOVER
                        </button>
                    </div>
                {% empty %}
                    <div class="lista-vazia-wrapper"><p class="lista-vazia-mensagem">Sua lista de favoritos está vazia.</p></div>
                {% endfor %}
            </div>
        </div>
        <div id="tab-lists" class="tab-pane">
            <div class="secao-listas-header">
                <h2 class="detalhe-secao-titulo">Minhas Listas Personalizadas</h2>
                <button id="abrirModalCriarLista" class="botao-add-geral" title="Criar Nova Lista">+</button>
            </div>
            <div class="listas-personalizadas-container">
                {% for lista_p in listas_personalizadas %}
                    <div class="lista-personalizada-card" id="lista-personalizada-{{ lista_p.id }}">
                        <div class="lista-card-header">
                            <a href="{% url 'usuarios:detalhe_lista' lista_id=lista_p.id %}" class="lista-card-titulo">{{ lista_p.nome }}</a>
                            <div class="lista-card-acoes">
                                <span class="lista-card-contador">{{ lista_p.filmes.count }} filme(s)</span>
                                <button class="botao-editar-lista-personalizada" data-list-id="{{ lista_p.id }}" title="Editar esta lista">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="botao-concluir-edicao-personalizada" data-list-id="{{ lista_p.id }}" style="display: none;" title="Concluir edição">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="botao-excluir-lista" data-list-id="{{ lista_p.id }}" data-list-name="{{ lista_p.nome|escapejs }}" title="Excluir a lista">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="lista-poster-preview preview-poster-grid" id="lista-preview-{{ lista_p.id }}"> 
                            {% for filme_lp in lista_p.filmes.all %}
                                <div class="preview-poster-item filme-item-wrapper-perfil" data-filme-card-idtmdb="{{ filme_lp.id_tmdb }}"> 
                                    <a href="{% url 'detalhe_filme' filme_id=filme_lp.id_tmdb %}" class="preview-poster-link">
                                    {% if filme_lp.poster_path %}
                                        <img src="{{ base_poster_url }}{{ filme_lp.poster_path }}" alt="{{ filme_lp.titulo }}">
                                    {% else %}
                                        <img class="imagem-placeholder" src="{% static 'img/placeholder_poster.png' %}" alt="Pôster indisponível">
                                    {% endif %}
                                    </a>
                                    <button class="botao botao-remover-filme-lista" 
                                            data-list-id="{{ lista_p.id }}" 
                                            data-id-tmdb="{{ filme_lp.id_tmdb }}"
                                            title="Remover '{{ filme_lp.titulo }}' desta lista">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            {% empty %}
                                <p class="preview-vazia lista-vazia-mensagem">Esta lista está vazia.</p>
                            {% endfor %}
                        </div>
                    </div>
                {% empty %}
                    <p class="lista-vazia-mensagem">Você ainda não criou nenhuma lista personalizada.</p>
                {% endfor %}
            </div>
        </div>
        <div id="tab-edit" class="tab-pane">
            <h2 class="detalhe-secao-titulo">Editar Informações do Perfil</h2>
            <div class="form-editar-perfil-wrapper">
                {% if perfil_form %}
                <form method="post" action="{% url 'usuarios:perfil_usuario' %}" class="form-editar-perfil-info">
                    {% csrf_token %}
                    <div class="form-group-perfil"><label for="{{ perfil_form.first_name.id_for_label }}">{{ perfil_form.first_name.label }}:</label>{{ perfil_form.first_name }}</div>
                    <div class="form-group-perfil"><label for="{{ perfil_form.last_name.id_for_label }}">{{ perfil_form.last_name.label }}:</label>{{ perfil_form.last_name }}</div>
                    <div class="form-group-perfil"><label for="{{ perfil_form.biografia.id_for_label }}">{{ perfil_form.biografia.label }}:</label>{{ perfil_form.biografia }}</div>
                    <div class="form-group-perfil"><label for="{{ perfil_form.cidade.id_for_label }}">{{ perfil_form.cidade.label }}:</label>{{ perfil_form.cidade }}</div>
                    <div class="form-group-perfil"><label for="{{ perfil_form.data_nascimento.id_for_label }}">{{ perfil_form.data_nascimento.label }}:</label>{{ perfil_form.data_nascimento }}</div>
                    <button type="submit" name="atualizar_perfil_info" class="botao-submit-perfil">Salvar Informações</button>
                </form>
                {% endif %}
            </div>
        </div>
        <div id="tab-account" class="tab-pane">
            <h2 class="detalhe-secao-titulo">Gerenciamento da Conta</h2>
            <div class="container-acao-perigo">
                <h3>Excluir Sua Conta</h3>
                <p>Ao prosseguir, sua conta e todos os dados associados serão permanentemente removidos. <strong>Esta ação é irreversível.</strong></p>
                <div class="botao-container-direita"><a href="{% url 'usuarios:excluir_conta' %}" class="botao-acao-perfil botao-acao-perfil--perigo"><i class="fas fa-trash-alt"></i> Excluir Minha Conta</a></div>
            </div>
        </div>
    </div>
</div>

<div id="cropModal" class="crop-modal">
    <div class="custom-modal-content">
        <h3>Recortar Imagem</h3>
        <div id="imageToCropInModalContainer"><img id="imageToCropInModal" src="#"></div>
        <div class="crop-modal-buttons">
            <button id="confirmCropButton" class="botao-submit-perfil">Cortar e Salvar</button>
            <button id="cancelCropButton" class="botao-cancelar-crop">Cancelar</button>
        </div>
    </div>
</div>
<div id="modalCriarLista" class="custom-modal-plume">
    <div class="custom-modal-content">
        <button class="custom-modal-close-btn">&times;</button>
        <h3>Criar Nova Lista</h3>
        <form method="POST" action="{% url 'usuarios:perfil_usuario' %}" class="form-criar-lista">
            {% csrf_token %}
            <div class="form-group-inline">
                <input type="text" name="nome_nova_lista" placeholder="Nome da nova lista" required class="input-nome-lista" maxlength="100">
                <button type="submit" name="criar_lista" class="botao-submit-lista">Criar</button>
            </div>
        </form>
    </div>
</div>
{% endblock content %}

{% block scripts %}
    {{ block.super }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script id="js-urls-perfil-data" type="application/json">
        {
            "saveAvatarUrl": "{% url 'usuarios:ajax_save_avatar_url' %}",
            "removerAvatarUrl": "{% url 'usuarios:ajax_remover_avatar' %}",
            "toggleFavoritoUrl": "{% url 'toggle_favorito' %}",
            "ajaxDeleteListUrl": "{% url 'usuarios:ajax_delete_list' %}",
            "removeFilmFromListUrl": "{% url 'usuarios:ajax_remove_film_from_list' %}"
        }
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const JS_URLS_PERFIL = JSON.parse(document.getElementById('js-urls-perfil-data').textContent);
        function getCookie(name) {
            if (document.cookie && document.cookie !== '') {
                for (const cookie of document.cookie.split(';')) {
                    const [key, value] = cookie.trim().split('=').map(decodeURIComponent);
                    if (key === name) return value;
                }
            } return null;
        }
        const csrftoken = getCookie('csrftoken');
        
        const tabLinks = document.querySelectorAll('.perfil-nav-tabs .nav-link');
        const tabPanes = document.querySelectorAll('.perfil-tab-content .tab-pane');
        tabLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                tabLinks.forEach(l => l.classList.remove('active'));
                tabPanes.forEach(p => p.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(this.dataset.tab).classList.add('active');
            });
        });

        const avatarUploadInput = document.getElementById('avatarUploadInput');
        const avatarDisplayImage = document.getElementById('avatarDisplay');
        const imageToCropElement = document.getElementById('imageToCropInModal');
        const cropModalElement = document.getElementById('cropModal');
        const confirmCropButton = document.getElementById('confirmCropButton');
        const cancelCropButton = document.getElementById('cancelCropButton');
        const removeAvatarButton = document.getElementById('removeAvatarButton');
        let cropperInstance = null;

        if (avatarUploadInput) {
            avatarUploadInput.addEventListener('change', function(event) {
                if (event.target.files && event.target.files[0]) {
                    imageToCropElement.src = URL.createObjectURL(event.target.files[0]);
                    cropModalElement.style.display = 'flex';
                    if (cropperInstance) cropperInstance.destroy();
                    cropperInstance = new Cropper(imageToCropElement, { aspectRatio: 1, viewMode: 1, autoCropArea: 1 });
                }
            });
        }
        if (cancelCropButton) cancelCropButton.addEventListener('click', () => { cropModalElement.style.display = 'none'; });

        if (confirmCropButton) {
            confirmCropButton.addEventListener('click', function() {
                if (!cropperInstance) return;
                confirmCropButton.textContent = 'Enviando...';
                confirmCropButton.disabled = true;

                cropperInstance.getCroppedCanvas({ width: 400, height: 400 }).toBlob(function(blob) {
                    const formData = new FormData();
                    formData.append('file', blob);
                    formData.append('upload_preset', 'ml_default');
                    
                    const CLOUD_NAME = "dgvik6wm6"; // Substitua pelo seu Cloud Name real
                    const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;

                    fetch(uploadUrl, { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                        if (data.public_id) {
                            return fetch(JS_URLS_PERFIL.saveAvatarUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                                body: JSON.stringify({ public_id: data.public_id })
                            });
                        } else { throw new Error('Falha no upload para o Cloudinary.'); }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            window.location.reload();
                        } else { throw new Error(data.message || 'Falha ao salvar no perfil.'); }
                    })
                    .catch(error => {
                        console.error('Erro no processo de upload:', error);
                        alert('Ocorreu um erro ao enviar seu avatar. Tente novamente.');
                    })
                    .finally(() => {
                        confirmCropButton.textContent = 'Cortar e Salvar';
                        confirmCropButton.disabled = false;
                        cropModalElement.style.display = 'none';
                    });
                });
            });
        }
        
        if (removeAvatarButton) {
            removeAvatarButton.addEventListener('click', function() {
                if(confirm("Tem certeza que deseja remover sua foto de perfil?")) {
                    fetch(JS_URLS_PERFIL.removerAvatarUrl, {method: 'POST', headers: { 'X-CSRFToken': csrftoken }})
                    .then(res => res.json())
                    .then(data => {
                        if(data.status === 'success') window.location.reload();
                        else alert(data.message || 'Erro ao remover foto.');
                    })
                }
            });
        }
        
        const abrirModalCriarListaBtn = document.getElementById('abrirModalCriarLista');
        const modalCriarLista = document.getElementById('modalCriarLista');
        const fecharModalCriarListaBtn = modalCriarLista ? modalCriarLista.querySelector('.custom-modal-close-btn') : null;

        if (abrirModalCriarListaBtn) {
            abrirModalCriarListaBtn.addEventListener('click', function() {
                if (modalCriarLista) {
                    modalCriarLista.style.display = 'flex';
                }
            });
        }

        if (fecharModalCriarListaBtn) {
            fecharModalCriarListaBtn.addEventListener('click', function() {
                if (modalCriarLista) {
                    modalCriarLista.style.display = 'none';
                }
            });
        }

        if (modalCriarLista) {
            window.addEventListener('click', function(event) {
                if (event.target == modalCriarLista) {
                    modalCriarLista.style.display = 'none';
                }
            });
        }
        
        const botaoEditarFavoritos = document.getElementById('botaoEditarFavoritos');
        const botaoConcluirEdicaoFavoritos = document.getElementById('botaoConcluirEdicaoFavoritos');
        const listaFavoritosContainer = document.getElementById('lista-favoritos-container');

        function toggleEditModeFavoritos(enable) {
            if (enable) {
                listaFavoritosContainer.classList.add('edit-mode');
                botaoEditarFavoritos.style.display = 'none';
                botaoConcluirEdicaoFavoritos.style.display = 'inline-block';
            } else {
                listaFavoritosContainer.classList.remove('edit-mode');
                botaoEditarFavoritos.style.display = 'inline-block';
                botaoConcluirEdicaoFavoritos.style.display = 'none';
            }
        }

        if (botaoEditarFavoritos) {
            botaoEditarFavoritos.addEventListener('click', function() {
                toggleEditModeFavoritos(true);
            });
        }
        if (botaoConcluirEdicaoFavoritos) {
            botaoConcluirEdicaoFavoritos.addEventListener('click', function() {
                toggleEditModeFavoritos(false);
            });
        }
        
        // --- CÓDIGO PARA EDIÇÃO DE LISTAS E DELEÇÃO DE FILMES (GERAL) ---
        const listasPersonalizadasContainer = document.querySelector('.listas-personalizadas-container');

        if (listasPersonalizadasContainer) {
            listasPersonalizadasContainer.addEventListener('click', function(event) {
                // Lógica para excluir a lista (botão da lixeira) - permanece
                const botaoExcluirLista = event.target.closest('.botao-excluir-lista');
                if (botaoExcluirLista) {
                    const listId = botaoExcluirLista.dataset.listId;
                    const listName = botaoExcluirLista.dataset.listName;
                    if(confirm(`Tem certeza que deseja excluir a lista "${listName}"?`)) {
                        fetch(JS_URLS_PERFIL.ajaxDeleteListUrl, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                            body: JSON.stringify({'id_lista': listId})
                        }).then(res => res.json()).then(data => {
                            if(data.status === 'ok') document.getElementById(`lista-personalizada-${listId}`).remove();
                            else alert(data.message || 'Erro ao excluir');
                        })
                    }
                }

                // Lógica para editar/concluir edição de lista personalizada
                const botaoEditarPersonalizada = event.target.closest('.botao-editar-lista-personalizada');
                const botaoConcluirPersonalizada = event.target.closest('.botao-concluir-edicao-personalizada');
                
                if (botaoEditarPersonalizada || botaoConcluirPersonalizada) {
                    const listaCard = event.target.closest('.lista-personalizada-card');
                    const listaPreviewFilmes = listaCard ? listaCard.querySelector('.preview-poster-grid') : null; // ALVO CORRETO AGORA
                    const editButton = listaCard ? listaCard.querySelector('.botao-editar-lista-personalizada') : null;
                    const doneButton = listaCard ? listaCard.querySelector('.botao-concluir-edicao-personalizada') : null;

                    if (listaPreviewFilmes && editButton && doneButton) {
                        if (botaoEditarPersonalizada) { // Se clicou em Editar
                            listaPreviewFilmes.classList.add('edit-mode');
                            editButton.style.display = 'none';
                            doneButton.style.display = 'inline-block';
                        } else if (botaoConcluirPersonalizada) { // Se clicou em Concluir
                            listaPreviewFilmes.classList.remove('edit-mode');
                            editButton.style.display = 'inline-block';
                            doneButton.style.display = 'none';
                        }
                    }
                }

                // Lógica para remover filme de lista (tanto favoritos quanto personalizadas)
                const botaoRemoverFilme = event.target.closest('.botao-remover-filme-lista');
                if (botaoRemoverFilme) {
                    const listaContainer = botaoRemoverFilme.closest('.filme-lista.perfil-filme-lista, .preview-poster-grid'); // PODE SER FAVORITOS OU LISTA PERSONALIZADA
                    
                    // Somente permite remover se o container pai estiver em modo de edição
                    if (listaContainer && listaContainer.classList.contains('edit-mode')) {
                        event.preventDefault(); 

                        const listId = botaoRemoverFilme.dataset.listId;
                        const filmeId = botaoRemoverFilme.dataset.idTmdb;
                        const filmeTitulo = botaoRemoverFilme.title.replace("Remover '", "").replace("' desta lista", "").replace("Remover dos Favoritos", "").trim(); // Lógica para obter o título de ambos os casos

                        if (!listId || !filmeId) {
                            alert('Erro: IDs de lista ou filme não encontrados.');
                            return;
                        }

                        if (confirm(`Tem certeza que deseja remover "${filmeTitulo}" desta lista?`)) {
                            fetch(JS_URLS_PERFIL.removeFilmFromListUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrftoken
                                },
                                body: JSON.stringify({ id_lista: listId, id_tmdb: filmeId })
                            })
                            .then(response => {
                                if (!response.ok) {
                                   return response.json().then(err => { 
                                       throw new Error(err.message || `Erro ${response.status} do servidor.`); 
                                   });
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.status === 'ok') {
                                    botaoRemoverFilme.closest('.filme-item-wrapper-perfil').remove();
                                    // ATUALIZA A CONTAGEM DE FILMES NO CARD DA LISTA PERSONALIZADA
                                    if (listaContainer.classList.contains('preview-poster-grid')) { // Apenas se for uma lista personalizada
                                        const listaCard = listaContainer.closest('.lista-personalizada-card');
                                        const contadorSpan = listaCard ? listaCard.querySelector('.lista-card-contador') : null;
                                        if (contadorSpan) {
                                            let currentCount = parseInt(contadorSpan.textContent.match(/\d+/)[0]); // Pega apenas o número
                                            contadorSpan.textContent = `${currentCount - 1} filme(s)`;
                                        }
                                    }
                                    
                                    // SE A LISTA FICAR VAZIA, EXIBE A MENSAGEM
                                    if (listaContainer.querySelectorAll('.filme-item-wrapper-perfil').length === 0) {
                                        let messageElem = listaContainer.querySelector('.lista-vazia-mensagem');
                                        if (!messageElem) { // Se a mensagem não existir, cria
                                            messageElem = document.createElement('p');
                                            messageElem.className = 'lista-vazia-mensagem';
                                            listaContainer.appendChild(messageElem);
                                        }
                                        messageElem.textContent = listaContainer.id === 'lista-favoritos-container' ? 
                                                                  'Sua lista de favoritos está vazia.' : 
                                                                  'Esta lista ficou vazia.';
                                        messageElem.style.display = 'block'; 
                                    }
                                } else {
                                    alert(data.message);
                                }
                            })
                            .catch(error => {
                                console.error('Falha na requisição:', error);
                                alert('Ocorreu um erro ao remover o filme: ' + error.message);
                            });
                        }
                    }
                }
            });
        }
        // --- FIM DO NOVO CÓDIGO ---

    });
    </script>
{% endblock scripts %}